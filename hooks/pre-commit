#!/bin/bash
# Pre-commit hook to check clang-format compliance

# Get list of staged C/C++ files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(c|cpp|cxx|cc|h|hpp|hxx)$')

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

# Check if clang-format is available
if ! command -v clang-format &> /dev/null; then
    echo "Error: clang-format is not installed or not in PATH"
    echo "Please install clang-format to use this hook"
    exit 1
fi

# Check if .clang-format exists
if [ ! -f ".clang-format" ]; then
    echo "Error: .clang-format file not found in repository root"
    exit 1
fi

FORMAT_ISSUES=0

echo "Checking clang-format compliance..."

for FILE in $STAGED_FILES; do
    # Run clang-format and compare with original
    clang-format "$FILE" | diff -u "$FILE" - > /dev/null
    if [ $? -ne 0 ]; then
        echo "  ✗ $FILE does not comply with .clang-format"
        FORMAT_ISSUES=1
    fi
done

if [ $FORMAT_ISSUES -eq 1 ]; then
    echo ""
    echo "Commit rejected: Some files do not comply with .clang-format"
    echo "Please run clang-format on the files listed above and stage them again:"
    echo ""
    echo "  clang-format -i <file>"
    echo ""
    echo "Or to format all staged files:"
    echo "  git diff --cached --name-only --diff-filter=ACM | grep -E '\.(c|cpp|cxx|cc|h|hpp|hxx)$' | xargs clang-format -i"
    echo ""
    exit 1
fi

echo "All staged files comply with .clang-format ✓"
exit 0
