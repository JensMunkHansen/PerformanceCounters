name: Build and Test Windows with Cached Dependencies

on:
  workflow_dispatch:
    inputs:
      build-mode:
        description: "Select build mode"
        required: true
        default: single
        type: choice
        options:
          - single
          - all
      library-type:
        description: "Select library type (only used for single mode)"
        required: false
        default: SHARED
        type: choice
        options:
          - STATIC
          - SHARED
      build-type:
        description: "Select build type (only used for single mode)"
        required: false
        default: Release
        type: choice
        options:
          - Debug
          - Release
          - Asan
      compiler:
        description: "Select compiler (only used for single mode)"
        required: false
        default: msvc
        type: choice
        options:
          - msvc
          - clangcl
      force-cache-refresh:
        description: "Force rebuild dependencies (clear cache)"
        required: false
        default: false
        type: boolean
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Automatic builds on push/PR
  build-and-test:
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    runs-on: windows-2022
    strategy:
      matrix:
        include:
          - compiler: msvc
            build-type: Release
      fail-fast: false

    env:
      COMPILER: ${{ matrix.compiler }}
      BUILD_TYPE: ${{ matrix.build-type }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Build and Test
        uses: ./.github/actions/build-test-windows
        with:
          compiler: ${{ matrix.compiler }}
          build-type: ${{ matrix.build-type }}

  # Manual builds - single configuration
  build-and-test-manual-single:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.build-mode == 'single'
    runs-on: windows-2022

    env:
      COMPILER: ${{ github.event.inputs.compiler }}
      BUILD_TYPE: ${{ github.event.inputs.build-type }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Build and Test
        uses: ./.github/actions/build-test-windows
        with:
          compiler: ${{ github.event.inputs.compiler }}
          build-type: ${{ github.event.inputs.build-type }}
          library-type: ${{ github.event.inputs.library-type }}

  # Manual builds - all configurations (msvc only)
  build-and-test-manual-all:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.build-mode == 'all'
    runs-on: windows-2022
    strategy:
      matrix:
        compiler: [msvc]
        build-type: [Debug, Release, Asan]
      fail-fast: false

    env:
      COMPILER: ${{ matrix.compiler }}
      BUILD_TYPE: ${{ matrix.build-type }}

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Build and Test
        uses: ./.github/actions/build-test-windows
        with:
          compiler: ${{ matrix.compiler }}
          build-type: ${{ matrix.build-type }}
